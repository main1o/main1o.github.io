<!doctype html>
<html lang="zh-cn">
  <head>
    <title>Redpwnctf_2019_challenges_web // main1o</title>
    <link rel="shortcut icon" href="ICON.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css" />
    

    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Redpwnctf_2019_challenges_web">
  <meta name="twitter:description" content="redpwnctf-2019-challenges-web 题目环境
这题目是nodejs原型链污染 下面是主要代码
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 const crypto = require(&#39;crypto&#39;) const http = require(&#39;http&#39;) const mustache = require(&#39;mustache&#39;) const getRawBody = require(&#39;raw-body&#39;) const _ = require(&#39;lodash&#39;) const flag = require(&#39;./flag&#39;) const indexTemplate = ` &lt;!doctype html&gt; &lt;style&gt; body { background: #172159; } * { color: #fff; } &lt;/style&gt; &lt;h1&gt;your public blueprints!&lt;/h1&gt; &lt;i&gt;(in compliance with military-grade security, we only show the public ones. you must have the unique URL to access private blueprints.)&lt;/i&gt; &lt;br&gt; {{#blueprints}} {{#public}} &lt;div&gt;&lt;br&gt;&lt;a href=&#34;/blueprints/{{id}}&#34;&gt;blueprint&lt;/a&gt;: {{content}}&lt;br&gt;&lt;/div&gt; {{/public}} {{/blueprints}} &lt;br&gt;&lt;a href=&#34;/make&#34;&gt;make your own blueprint!&lt;/a&gt; ` const blueprintTemplate = ` &lt;!doctype html&gt; &lt;style&gt; body { background: #172159; color: #fff; } &lt;/style&gt; &lt;h1&gt;blueprint!&lt;/h1&gt; {{content}} ` const notFoundPage = ` &lt;!doctype html&gt; &lt;style&gt; body { background: #172159; color: #fff; } &lt;/style&gt; &lt;h1&gt;404&lt;/h1&gt; ` const makePage = ` &lt;!doctype html&gt; &lt;style&gt; body { background: #172159; color: #fff; } &lt;/style&gt; &lt;div&gt;content:&lt;/div&gt; &lt;textarea id=&#34;content&#34;&gt;&lt;/textarea&gt; &lt;br&gt; &lt;span&gt;public:&lt;/span&gt; &lt;input type=&#34;checkbox&#34; id=&#34;public&#34;&gt; &lt;br&gt;&lt;br&gt; &lt;button id=&#34;submit&#34;&gt;create blueprint!&lt;/button&gt; &lt;script&gt; submit.addEventListener(&#39;click&#39;, () =&gt; { fetch(&#39;/make&#39;, { method: &#39;POST&#39;, headers: { &#39;content-type&#39;: &#39;application/json&#39;, }, body: JSON.stringify({ content: content.value, public: public.checked, }) }).then(res =&gt; res.text()).then(id =&gt; location=&#39;/blueprints/&#39; &#43; id) }) &lt;/script&gt; ` // very janky, but it works const parseUserId = (cookies) =&gt; { if (cookies === undefined) { // 判断是否未定义 return null } const userIdCookie = cookies.split(&#39;; &#39;).find(cookie =&gt; cookie.startsWith(&#39;user_id=&#39;)) // 使用;分割并且查找名为&#34;user_id=&#34;的值 if (userIdCookie === undefined) { // 值为空返回null return null } return decodeURIComponent(userIdCookie.replace(&#39;user_id=&#39;, &#39;&#39;)) // url解码，替换值为空 } const makeId = () =&gt; crypto.randomBytes(16).toString(&#39;hex&#39;) // 随机hash // list of users and blueprints const users = new Map() http.createServer((req, res) =&gt; { let userId = parseUserId(req.headers.cookie) // 获取请求cookie let user = users.get(userId) // 存放cookie if (userId === null || user === undefined) { // 没有Cookie // create user if one doesnt exist userId = makeId() user = { blueprints: { [makeId()]: { // hash存储 content: flag, }, }, } users.set(userId, user) // 设置hash为索引存放content } // send back the user id res.writeHead(200, { &#39;set-cookie&#39;: &#39;user_id=&#39; &#43; encodeURIComponent(userId) &#43; &#39;; Path=/&#39;, // url编码后的 }) if (req.url === &#39;/&#39; &amp;&amp; req.method === &#39;GET&#39;) { // 列出所有 res.end(mustache.render(indexTemplate, { blueprints: Object.entries(user.blueprints).map(([k, v]) =&gt; ({ id: k, content: v.content, public: v.public, })), })) } else if (req.url.startsWith(&#39;/blueprints/&#39;) &amp;&amp; req.method === &#39;GET&#39;) { // show an individual blueprint, including private ones const blueprintId = req.url.replace(&#39;/blueprints/&#39;, &#39;&#39;) if (user.blueprints[blueprintId] === undefined) { res.end(notFoundPage) // 判断是否有id return } res.end(mustache.render(blueprintTemplate, { content: user.blueprints[blueprintId].content, // 返回对应id的content })) } else if (req.url === &#39;/make&#39; &amp;&amp; req.method === &#39;GET&#39;) { // show the static blueprint creation page res.end(makePage) } else if (req.url === &#39;/make&#39; &amp;&amp; req.method === &#39;POST&#39;) { // API used by the creation page getRawBody(req, { limit: &#39;1mb&#39;, }, (err, body) =&gt; { if (err) { throw err } let parsedBody try { // default values are easier to do than proper input validation parsedBody = _.defaultsDeep({ // 数组拷贝，json数据为可控的body publiс: false, // default private cоntent: &#39;&#39;, // default no content }, JSON.parse(body)) } catch (e) { res.end(&#39;bad json&#39;) return } // make the blueprint const blueprintId = makeId() user.blueprints[blueprintId] = { content: parsedBody.content, public: parsedBody.public, } res.end(blueprintId) }) } else { res.end(notFoundPage) } }).listen(80, () =&gt; { console.log(&#39;listening on port 80&#39;) }) 分析得知，如果没有Cookie则随机生成hash。并且flag在blueprints , 在随机生成一个id关联flag">

    <meta property="og:url" content="https://main1o.github.io/p/redpwnctf_2019_challenges_web/">
  <meta property="og:site_name" content="main1o">
  <meta property="og:title" content="Redpwnctf_2019_challenges_web">
  <meta property="og:description" content="redpwnctf-2019-challenges-web 题目环境
这题目是nodejs原型链污染 下面是主要代码
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 const crypto = require(&#39;crypto&#39;) const http = require(&#39;http&#39;) const mustache = require(&#39;mustache&#39;) const getRawBody = require(&#39;raw-body&#39;) const _ = require(&#39;lodash&#39;) const flag = require(&#39;./flag&#39;) const indexTemplate = ` &lt;!doctype html&gt; &lt;style&gt; body { background: #172159; } * { color: #fff; } &lt;/style&gt; &lt;h1&gt;your public blueprints!&lt;/h1&gt; &lt;i&gt;(in compliance with military-grade security, we only show the public ones. you must have the unique URL to access private blueprints.)&lt;/i&gt; &lt;br&gt; {{#blueprints}} {{#public}} &lt;div&gt;&lt;br&gt;&lt;a href=&#34;/blueprints/{{id}}&#34;&gt;blueprint&lt;/a&gt;: {{content}}&lt;br&gt;&lt;/div&gt; {{/public}} {{/blueprints}} &lt;br&gt;&lt;a href=&#34;/make&#34;&gt;make your own blueprint!&lt;/a&gt; ` const blueprintTemplate = ` &lt;!doctype html&gt; &lt;style&gt; body { background: #172159; color: #fff; } &lt;/style&gt; &lt;h1&gt;blueprint!&lt;/h1&gt; {{content}} ` const notFoundPage = ` &lt;!doctype html&gt; &lt;style&gt; body { background: #172159; color: #fff; } &lt;/style&gt; &lt;h1&gt;404&lt;/h1&gt; ` const makePage = ` &lt;!doctype html&gt; &lt;style&gt; body { background: #172159; color: #fff; } &lt;/style&gt; &lt;div&gt;content:&lt;/div&gt; &lt;textarea id=&#34;content&#34;&gt;&lt;/textarea&gt; &lt;br&gt; &lt;span&gt;public:&lt;/span&gt; &lt;input type=&#34;checkbox&#34; id=&#34;public&#34;&gt; &lt;br&gt;&lt;br&gt; &lt;button id=&#34;submit&#34;&gt;create blueprint!&lt;/button&gt; &lt;script&gt; submit.addEventListener(&#39;click&#39;, () =&gt; { fetch(&#39;/make&#39;, { method: &#39;POST&#39;, headers: { &#39;content-type&#39;: &#39;application/json&#39;, }, body: JSON.stringify({ content: content.value, public: public.checked, }) }).then(res =&gt; res.text()).then(id =&gt; location=&#39;/blueprints/&#39; &#43; id) }) &lt;/script&gt; ` // very janky, but it works const parseUserId = (cookies) =&gt; { if (cookies === undefined) { // 判断是否未定义 return null } const userIdCookie = cookies.split(&#39;; &#39;).find(cookie =&gt; cookie.startsWith(&#39;user_id=&#39;)) // 使用;分割并且查找名为&#34;user_id=&#34;的值 if (userIdCookie === undefined) { // 值为空返回null return null } return decodeURIComponent(userIdCookie.replace(&#39;user_id=&#39;, &#39;&#39;)) // url解码，替换值为空 } const makeId = () =&gt; crypto.randomBytes(16).toString(&#39;hex&#39;) // 随机hash // list of users and blueprints const users = new Map() http.createServer((req, res) =&gt; { let userId = parseUserId(req.headers.cookie) // 获取请求cookie let user = users.get(userId) // 存放cookie if (userId === null || user === undefined) { // 没有Cookie // create user if one doesnt exist userId = makeId() user = { blueprints: { [makeId()]: { // hash存储 content: flag, }, }, } users.set(userId, user) // 设置hash为索引存放content } // send back the user id res.writeHead(200, { &#39;set-cookie&#39;: &#39;user_id=&#39; &#43; encodeURIComponent(userId) &#43; &#39;; Path=/&#39;, // url编码后的 }) if (req.url === &#39;/&#39; &amp;&amp; req.method === &#39;GET&#39;) { // 列出所有 res.end(mustache.render(indexTemplate, { blueprints: Object.entries(user.blueprints).map(([k, v]) =&gt; ({ id: k, content: v.content, public: v.public, })), })) } else if (req.url.startsWith(&#39;/blueprints/&#39;) &amp;&amp; req.method === &#39;GET&#39;) { // show an individual blueprint, including private ones const blueprintId = req.url.replace(&#39;/blueprints/&#39;, &#39;&#39;) if (user.blueprints[blueprintId] === undefined) { res.end(notFoundPage) // 判断是否有id return } res.end(mustache.render(blueprintTemplate, { content: user.blueprints[blueprintId].content, // 返回对应id的content })) } else if (req.url === &#39;/make&#39; &amp;&amp; req.method === &#39;GET&#39;) { // show the static blueprint creation page res.end(makePage) } else if (req.url === &#39;/make&#39; &amp;&amp; req.method === &#39;POST&#39;) { // API used by the creation page getRawBody(req, { limit: &#39;1mb&#39;, }, (err, body) =&gt; { if (err) { throw err } let parsedBody try { // default values are easier to do than proper input validation parsedBody = _.defaultsDeep({ // 数组拷贝，json数据为可控的body publiс: false, // default private cоntent: &#39;&#39;, // default no content }, JSON.parse(body)) } catch (e) { res.end(&#39;bad json&#39;) return } // make the blueprint const blueprintId = makeId() user.blueprints[blueprintId] = { content: parsedBody.content, public: parsedBody.public, } res.end(blueprintId) }) } else { res.end(notFoundPage) } }).listen(80, () =&gt; { console.log(&#39;listening on port 80&#39;) }) 分析得知，如果没有Cookie则随机生成hash。并且flag在blueprints , 在随机生成一个id关联flag">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2023-08-29T23:10:53+08:00">
    <meta property="article:modified_time" content="2023-08-29T23:10:53+08:00">
    <meta property="article:tag" content="Nodejs">
    <meta property="article:tag" content="Ctf">


  </head>
  <body>
    <header class="app-header">
      <a href="/"><img class="app-header-avatar" src="/avatar.jpg" alt="John Doe" /></a>
      <span class="app-header-title">main1o</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
             - 
          
          <a class="app-header-menu-item" href="/about/">About</a>
      </nav>
      <p>荆棘之路</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Redpwnctf_2019_challenges_web</h1>
      <div class="post-meta">
        <div>
          <svg class="icon icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          Aug 29, 2023
        </div>
        <div>
          <svg class="icon icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>clock</title><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          5 min read
        </div>
        <div>
          <svg class="icon icon-tag" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
              <a class="tag" href="/tags/nodejs/">Nodejs</a>
              <a class="tag" href="/tags/ctf/">Ctf</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <h1 id="redpwnctf-2019-challenges-web">redpwnctf-2019-challenges-web</h1>
<blockquote>
<p><a href="https://github.com/redpwn/redpwnctf-2019-challenges/tree/master/web/blueprint">题目环境</a></p>
</blockquote>
<p>这题目是nodejs原型链污染 下面是主要代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">mustache</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mustache&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">getRawBody</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;raw-body&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">flag</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./flag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">indexTemplate</span> <span class="o">=</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;!doctype html&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;style&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  body {
</span></span></span><span class="line"><span class="cl"><span class="sb">    background: #172159;
</span></span></span><span class="line"><span class="cl"><span class="sb">  }
</span></span></span><span class="line"><span class="cl"><span class="sb">  * {
</span></span></span><span class="line"><span class="cl"><span class="sb">    color: #fff;
</span></span></span><span class="line"><span class="cl"><span class="sb">  }
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;/style&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;h1&gt;your public blueprints!&lt;/h1&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;i&gt;(in compliance with military-grade security, we only show the public ones. you must have the unique URL to access private blueprints.)&lt;/i&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;br&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">{{#blueprints}}
</span></span></span><span class="line"><span class="cl"><span class="sb">  {{#public}}
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;div&gt;&lt;br&gt;&lt;a href=&#34;/blueprints/{{id}}&#34;&gt;blueprint&lt;/a&gt;: {{content}}&lt;br&gt;&lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  {{/public}}
</span></span></span><span class="line"><span class="cl"><span class="sb">{{/blueprints}}
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;br&gt;&lt;a href=&#34;/make&#34;&gt;make your own blueprint!&lt;/a&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">blueprintTemplate</span> <span class="o">=</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;!doctype html&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;style&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  body {
</span></span></span><span class="line"><span class="cl"><span class="sb">    background: #172159;
</span></span></span><span class="line"><span class="cl"><span class="sb">    color: #fff;
</span></span></span><span class="line"><span class="cl"><span class="sb">  }
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;/style&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;h1&gt;blueprint!&lt;/h1&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">{{content}}
</span></span></span><span class="line"><span class="cl"><span class="sb">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">notFoundPage</span> <span class="o">=</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;!doctype html&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;style&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  body {
</span></span></span><span class="line"><span class="cl"><span class="sb">    background: #172159;
</span></span></span><span class="line"><span class="cl"><span class="sb">    color: #fff;
</span></span></span><span class="line"><span class="cl"><span class="sb">  }
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;/style&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;h1&gt;404&lt;/h1&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">makePage</span> <span class="o">=</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;!doctype html&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;style&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  body {
</span></span></span><span class="line"><span class="cl"><span class="sb">    background: #172159;
</span></span></span><span class="line"><span class="cl"><span class="sb">    color: #fff;
</span></span></span><span class="line"><span class="cl"><span class="sb">  }
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;/style&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;div&gt;content:&lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;textarea id=&#34;content&#34;&gt;&lt;/textarea&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;br&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;span&gt;public:&lt;/span&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;input type=&#34;checkbox&#34; id=&#34;public&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;br&gt;&lt;br&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;button id=&#34;submit&#34;&gt;create blueprint!&lt;/button&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;script&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  submit.addEventListener(&#39;click&#39;, () =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="sb">    fetch(&#39;/make&#39;, {
</span></span></span><span class="line"><span class="cl"><span class="sb">      method: &#39;POST&#39;,
</span></span></span><span class="line"><span class="cl"><span class="sb">      headers: {
</span></span></span><span class="line"><span class="cl"><span class="sb">        &#39;content-type&#39;: &#39;application/json&#39;,
</span></span></span><span class="line"><span class="cl"><span class="sb">      },
</span></span></span><span class="line"><span class="cl"><span class="sb">      body: JSON.stringify({
</span></span></span><span class="line"><span class="cl"><span class="sb">        content: content.value,
</span></span></span><span class="line"><span class="cl"><span class="sb">        public: public.checked,
</span></span></span><span class="line"><span class="cl"><span class="sb">      })
</span></span></span><span class="line"><span class="cl"><span class="sb">    }).then(res =&gt; res.text()).then(id =&gt; location=&#39;/blueprints/&#39; + id)
</span></span></span><span class="line"><span class="cl"><span class="sb">  })
</span></span></span><span class="line"><span class="cl"><span class="sb">&lt;/script&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// very janky, but it works
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">parseUserId</span> <span class="o">=</span> <span class="p">(</span><span class="nx">cookies</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">cookies</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 判断是否未定义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userIdCookie</span> <span class="o">=</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;; &#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">cookie</span> <span class="p">=&gt;</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;user_id=&#39;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">// 使用;分割并且查找名为&#34;user_id=&#34;的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">userIdCookie</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// 值为空返回null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">userIdCookie</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;user_id=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="c1">// url解码，替换值为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">makeId</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span> <span class="c1">// 随机hash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// list of users and blueprints
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">parseUserId</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)</span> <span class="c1">// 获取请求cookie
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">users</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span> <span class="c1">// 存放cookie
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">userId</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 没有Cookie
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// create user if one doesnt exist
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">userId</span> <span class="o">=</span> <span class="nx">makeId</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">blueprints</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="nx">makeId</span><span class="p">()]</span><span class="o">:</span> <span class="p">{</span>  <span class="c1">// hash存储
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">content</span><span class="o">:</span> <span class="nx">flag</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">users</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="c1">// 设置hash为索引存放content
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// send back the user id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;set-cookie&#39;</span><span class="o">:</span> <span class="s1">&#39;user_id=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;; Path=/&#39;</span><span class="p">,</span> <span class="c1">// url编码后的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 列出所有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">mustache</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">indexTemplate</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">blueprints</span><span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">blueprints</span><span class="p">).</span><span class="nx">map</span><span class="p">(([</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="o">:</span> <span class="nx">k</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="o">:</span> <span class="nx">v</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">public</span><span class="o">:</span> <span class="nx">v</span><span class="p">.</span><span class="kr">public</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">})),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}))</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/blueprints/&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// show an individual blueprint, including private ones
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">blueprintId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;/blueprints/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">blueprints</span><span class="p">[</span><span class="nx">blueprintId</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">notFoundPage</span><span class="p">)</span>  <span class="c1">// 判断是否有id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">mustache</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">blueprintTemplate</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">blueprints</span><span class="p">[</span><span class="nx">blueprintId</span><span class="p">].</span><span class="nx">content</span><span class="p">,</span> <span class="c1">// 返回对应id的content
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}))</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">===</span> <span class="s1">&#39;/make&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// show the static blueprint creation page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">makePage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">===</span> <span class="s1">&#39;/make&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;POST&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// API used by the creation page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">getRawBody</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">limit</span><span class="o">:</span> <span class="s1">&#39;1mb&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">parsedBody</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// default values are easier to do than proper input validation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">parsedBody</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaultsDeep</span><span class="p">({</span>  <span class="c1">// 数组拷贝，json数据为可控的body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">publiс</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// default private
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">cоntent</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">// default no content
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">},</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;bad json&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// make the blueprint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kr">const</span> <span class="nx">blueprintId</span> <span class="o">=</span> <span class="nx">makeId</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="nx">user</span><span class="p">.</span><span class="nx">blueprints</span><span class="p">[</span><span class="nx">blueprintId</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="o">:</span> <span class="nx">parsedBody</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">public</span><span class="o">:</span> <span class="nx">parsedBody</span><span class="p">.</span><span class="kr">public</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">blueprintId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">notFoundPage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;listening on port 80&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析得知，如果没有Cookie则随机生成hash。并且<code>flag</code>在<code>blueprints</code> , 在随机生成一个id关联flag</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">parseUserId</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)</span> <span class="c1">// 获取请求cookie
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">users</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span> <span class="c1">// 存放cookie
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">userId</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 没有Cookie
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// create user if one doesnt exist
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">userId</span> <span class="o">=</span> <span class="nx">makeId</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">blueprints</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="nx">makeId</span><span class="p">()]</span><span class="o">:</span> <span class="p">{</span>  <span class="c1">// hash存储
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">content</span><span class="o">:</span> <span class="nx">flag</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">users</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="c1">// 设置hash为索引存放content
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看输出的代码，有一个<code>public</code>属性并且``value<code>必须为</code>public`才行, 上面的flag_user是没有这个属性的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 列出所有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">mustache</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">indexTemplate</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">blueprints</span><span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">blueprints</span><span class="p">).</span><span class="nx">map</span><span class="p">(([</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="o">:</span> <span class="nx">k</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="o">:</span> <span class="nx">v</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">public</span><span class="o">:</span> <span class="nx">v</span><span class="p">.</span><span class="kr">public</span><span class="p">,</span> <span class="c1">// 只有公有可见
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">})),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后是 这里设置默认的<code>publiс</code>默认为false。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"> <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// default values are easier to do than proper input validation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">parsedBody</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaultsDeep</span><span class="p">({</span>  <span class="c1">// 数组拷贝，json数据为可控的body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">publiс</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// default private
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">cоntent</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">// default no content
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">},</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;bad json&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>flag键名为<code>content</code>， 在<code>{}</code>包裹中 所以要对<code>{}</code>原型进行注入 使它有<code>public:</code>。js中万物皆对象，<code>constructor</code>属性也是<strong>对象才拥有的</strong>  对象指向一个函数，指向<strong>该对象的构造函数</strong> 这里就是Object() , 污染它 添加public属性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="s2">&#34;constructor&#34;</span><span class="err">:</span><span class="p">{</span><span class="nt">&#34;prototype&#34;</span><span class="p">:{</span><span class="nt">&#34;public&#34;</span><span class="p">:</span><span class="kc">true</span><span class="p">}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/redpwnctf_2019_challenges_web/image-20230829225505085.png" alt="image-20230829225505085"></p>
<p>构建数据包</p>
<p><img src="/p/redpwnctf_2019_challenges_web/image-20230829230607583.png" alt="image-20230829230607583"></p>
<p>回到首页查看全部，就以及有flag了</p>
<p><img src="/p/redpwnctf_2019_challenges_web/image-20230829230310472.png" alt="image-20230829230310472"></p>
<h2 id="lodash-原型漏洞">lodash 原型漏洞</h2>
<blockquote>
<p>版本小于 <code>4.17.10</code>	参考 <a href="https://hackerone.com/reports/380873">https://hackerone.com/reports/380873</a></p>
</blockquote>
<h2 id="参考链接">🔗参考链接</h2>
<blockquote>
<p><a href="https://www.cnblogs.com/tr1ple/p/11360881.html#BhRbSi43">https://www.cnblogs.com/tr1ple/p/11360881.html#BhRbSi43</a></p>
<p><a href="https://ce-automne.github.io/2019/11/09/RedPwnCTF-2019-blueprint-WriteUp/">https://ce-automne.github.io/2019/11/09/RedPwnCTF-2019-blueprint-WriteUp/</a></p>
</blockquote>
<p>YouTube:</p>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/xOyAg-6Jwx8?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>


      <script src="https://giscus.app/client.js"
        data-repo="main1o/CommentRepository"
        data-repo-id="R_kgDOQJuvig"
        data-category="Q&A"
        data-category-id="DIC_kwDOQJuvis4CxG_t"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
